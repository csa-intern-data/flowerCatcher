<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flower Catcher</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: manipulation;
        }
        
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        #backgroundImage {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        
        #welcomeScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            background-image: url('https://dl3.pushbulletusercontent.com/HlUFKIRK9bwDrUaR0MM6tLauGpIi9NYM/Thumbnail.jpg');
            background-size: cover;
            background-position: center;
        }
        
        #titleImage {
            width: 80%;
            max-width: 500px;
            margin-bottom: 20px;
        }
        
        #subtextImage {
            width: 70%;
            max-width: 400px;
            margin-bottom: 40px;
        }
        
        #playButton {
            width: 150px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        #playButton:hover {
            transform: scale(1.05);
        }
        
        #gameCanvas {
            position: absolute;
            z-index: 5;
            display: none;
        }
        
        #scoreBoard {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 60px;
            background-image: url('https://dl3.pushbulletusercontent.com/O69AWgDoCCGTuZFXskiAW5jW2AYu0oVU/Score%20Board.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            display: none;
        }
        
        #scoreText {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            padding-bottom: 5px;
        }
        
        #timerDisplay {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 20px;
            font-weight: bold;
            color: #ff69b4;
            z-index: 20;
            display: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 30;
            display: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        #finalScore {
            font-size: 24px;
            margin: 20px 0;
            color: #ff69b4;
        }
        
        #playAgain {
            width: 150px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- Background -->
        <img id="backgroundImage" src="https://dl3.pushbulletusercontent.com/EeCvNGCb29c3G05kNHLJMDezLnckrItz/Background%20UI.jpg" alt="Background">
        
        <!-- Welcome Screen -->
        <div id="welcomeScreen">
            <img id="titleImage" src="https://dl3.pushbulletusercontent.com/EG3WNBYH62xlWn7TfWCjA88QX3EBKCec/Title.png" alt="Flower Catcher">
            <img id="subtextImage" src="https://dl3.pushbulletusercontent.com/ZXdt3lqusDIXM3CQ45hNAdkl9G8F1D9V/Sub%20Text.png" alt="Catch the falling flowers">
            <img id="playButton" src="https://dl3.pushbulletusercontent.com/HL4GefaeXm75VDK7BPeY2Bhj8LTkRXdf/Play%20Button.png" alt="Play" onclick="startGame()">
        </div>
        
        <!-- Game Canvas -->
        <canvas id="gameCanvas"></canvas>
        
        <!-- Score Display -->
        <div id="scoreBoard">
            <div id="scoreText">0</div>
        </div>
        
        <!-- Timer Display -->
        <div id="timerDisplay">30s</div>
        
        <!-- Game Over Screen -->
        <div id="gameOver">
            <h2>Game Over!</h2>
            <p id="finalScore">Your score: 0</p>
            <img id="playAgain" src="https://dl3.pushbulletusercontent.com/HL4GefaeXm75VDK7BPeY2Bhj8LTkRXdf/Play%20Button.png" alt="Play Again">
        </div>

        <!-- Coupon Modal -->
        <div id="couponModal" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 100;">
            <div style="background-color: white; padding: 20px; border-radius: 10px; text-align: center; max-width: 80%; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);">
                <h2 id="couponTitle">SPECIAL OFFER</h2>
                <p>Congratulations on your score!</p>
                <div style="margin: 20px 0; background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); padding: 15px; border-radius: 8px; border: 2px dashed #3498db;">
                    <h3 id="discountText">20% OFF</h3>
                    <p>Your coupon code:</p>
                    <div style="font-family: monospace; font-size: 24px; font-weight: bold; background: white; padding: 10px; border-radius: 5px; margin: 10px 0; color: #e74c3c;" id="couponCode">FLOWERS20</div>
                    <p id="couponDescription">Valid for 14 days on all products</p>
                </div>
                <button id="closeCouponButton" style="background-color: #ff69b4; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px;">Got it!</button>
            </div>
        </div>
    </div>

    <!-- CleverTap Integration -->
    <script type="text/javascript">
        // Configuration variables for coupons - easy to modify
        const COUPON_CONFIG = {
            low: {
                minScore: 0,
                maxScore: 10,
                title: "BRONZE OFFER",
                discount: "10% OFF",
                code: "FLOWERS10",
                description: "Valid for 7 days on select items"
            },
            medium: {
                minScore: 11,
                maxScore: 20,
                title: "SILVER OFFER",
                discount: "20% OFF",
                code: "FLOWERS20",
                description: "Valid for 14 days on all products"
            },
            high: {
                minScore: 21,
                maxScore: 100,
                title: "GOLD OFFER",
                discount: "30% OFF",
                code: "FLOWERS30",
                description: "Valid for 30 days storewide"
            }
        };
        
        // CleverTap account credentials 
        // TODO: Replace with your CleverTap account ID
        const CLEVERTAP_ACCOUNT_ID = "YOUR_ACCOUNT_ID";
    </script>

    <!-- CleverTap SDK -->
    <script type="text/javascript">
        // Initialize CleverTap
        var clevertap = {event:[], profile:[], account:[], onUserLogin:[], notifications:[], privacy:[]};
        clevertap.account.push({"id": CLEVERTAP_ACCOUNT_ID});
        (function () {
            var wzrk = document.createElement('script');
            wzrk.type = 'text/javascript';
            wzrk.async = true;
            wzrk.src = ('https:' == document.location.protocol ? 'https://d2r1yp2w7bby2u.cloudfront.net' : 'http://static.clevertap.com') + '/js/clevertap.min.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(wzrk, s);
        })();
    </script>

    <script>
        // Load images
        const bucketImage = new Image();
        bucketImage.src = 'https://dl3.pushbulletusercontent.com/7OrQDOa4SKEjSzXLPBRPPAcVwhFn9hC5/Bucket.png';

        // Wait for bucket image to load to get natural dimensions
        bucketImage.onload = function() {
            // Calculate proper aspect ratio based on natural dimensions
            const aspectRatio = bucketImage.naturalWidth / bucketImage.naturalHeight;
            basketWidth = Math.round(basketHeight * aspectRatio);
            
            if (gameActive) {
                // If game is already running, adjust canvas
                setupCanvas();
            }
        };
        
        // DOM Elements
        const welcomeScreen = document.getElementById('welcomeScreen');
        const gameCanvas = document.getElementById('gameCanvas');
        const scoreBoard = document.getElementById('scoreBoard');
        const scoreText = document.getElementById('scoreText');
        const timerDisplay = document.getElementById('timerDisplay');
        const gameOverScreen = document.getElementById('gameOver');
        const finalScore = document.getElementById('finalScore');
        const playAgainButton = document.getElementById('playAgain');
        const couponModal = document.getElementById('couponModal');
        const couponTitle = document.getElementById('couponTitle');
        const discountText = document.getElementById('discountText');
        const couponCode = document.getElementById('couponCode');
        const couponDescription = document.getElementById('couponDescription');
        const closeCouponButton = document.getElementById('closeCouponButton');
        
        // Canvas setup
        const ctx = gameCanvas.getContext('2d');
        
        // Game variables
        let score = 0;
        let lives = 1;
        let flowers = [];
        let basketX;
        let basketY;
        let basketHeight = 140;
        let basketWidth = 140;
        let gameActive = false;
        let animationId;
        let baseFlowerSpeed = 3;
        let spawnRate = 1000; // Reduced from 1500ms to 1000ms for more action
        let lastSpawnTime = 0;
        let touchStartX = 0;
        let gameTimer = 30; // 30 seconds timer
        let timerInterval;
        
        // Flower colors for the petal-only design (soft pastels that match mockup)
        const flowerColors = ['#ff9ecf', '#ffb6e6', '#ffc8f0', '#ffd6f5', '#ffe4fa'];
        
        // Initialize canvas size to match window
        function setupCanvas() {
            gameCanvas.width = window.innerWidth;
            gameCanvas.height = window.innerHeight;
            basketX = gameCanvas.width / 2;
            basketY = gameCanvas.height - basketHeight - 20;
        }
        
        function startGame() {
            setupCanvas();
            welcomeScreen.style.display = 'none';
            gameCanvas.style.display = 'block';
            scoreBoard.style.display = 'flex';
            timerDisplay.style.display = 'block';
            gameOverScreen.style.display = 'none';
            couponModal.style.display = 'none';
            
            score = 0;
            lives = 1;
            flowers = [];
            basketX = gameCanvas.width / 2;
            gameTimer = 30;
            gameActive = true;
            lastSpawnTime = Date.now();
            
            updateScore();
            updateTimer();
            
            // Start the timer countdown
            clearInterval(timerInterval);
            timerInterval = setInterval(function() {
                gameTimer--;
                updateTimer();
                
                if (gameTimer <= 0) {
                    clearInterval(timerInterval);
                    endGame(true); // Pass true to indicate time expired
                }
            }, 1000);
            
            // Start the game loop
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            gameLoop();
        }
        
        function gameLoop() {
            clearCanvas();
            spawnFlowers();
            moveFlowers();
            checkCollisions();
            drawBasket();
            drawFlowers();
            
            if (gameActive) {
                animationId = requestAnimationFrame(gameLoop);
            }
        }
        
        function clearCanvas() {
            ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
        }
        
        function spawnFlowers() {
            const currentTime = Date.now();
            if (currentTime - lastSpawnTime > spawnRate) {
                const flowerSize = Math.random() * 15 + 25; // Smaller flowers (25-40px)
                const x = Math.random() * (gameCanvas.width - flowerSize);
                const color = flowerColors[Math.floor(Math.random() * flowerColors.length)];
                
                // Random speed for each flower (some fast, some slow)
                const speedMultiplier = Math.random() * 1.5 + 0.5; // 0.5x to 2.0x base speed
                const speed = baseFlowerSpeed * speedMultiplier;
                
                // Occasionally spawn a "special" fast flower (gold color)
                const isSpecial = Math.random() < 0.15; // 15% chance for special flower
                
                flowers.push({
                    x: x,
                    y: -flowerSize,
                    size: flowerSize,
                    color: isSpecial ? '#ffdf00' : color, // Golden color for special flowers
                    speed: isSpecial ? speed * 2 : speed, // Special flowers move twice as fast
                    counted: false,
                    rotation: Math.random() * Math.PI * 2,
                    rotationSpeed: Math.random() * 0.03 - 0.015,
                    isSpecial: isSpecial,
                    points: isSpecial ? 3 : 1 // Special flowers worth 3 points
                });
                
                lastSpawnTime = currentTime;
                
                // Increase difficulty as game progresses
                if (gameTimer < 20 && spawnRate > 700) {
                    spawnRate = 700; // More flowers in the middle of the game
                }
                if (gameTimer < 10 && spawnRate > 500) {
                    spawnRate = 500; // Even more flowers near the end
                }
                
                // Also gradually increase base speed
                if (gameTimer < 15) {
                    baseFlowerSpeed = 4;
                }
                if (gameTimer < 5) {
                    baseFlowerSpeed = 5;
                }
            }
        }
        
        function moveFlowers() {
            for (let i = 0; i < flowers.length; i++) {
                const flower = flowers[i];
                flower.y += flower.speed;
                flower.rotation += flower.rotationSpeed;
                
                // Check if flower is missed
                if (flower.y > gameCanvas.height && !flower.counted) {
                    flowers.splice(i, 1);
                    lives--;
                    
                    if (lives <= 0) {
                        endGame();
                    }
                    i--;
                }
            }
        }
        
        function checkCollisions() {
            for (let i = 0; i < flowers.length; i++) {
                const flower = flowers[i];
                
                // Simple collision detection with the basket
                const flowerCenterX = flower.x + flower.size / 2;
                const flowerBottom = flower.y + flower.size;
                
                if (flowerBottom > basketY && 
                    flowerBottom < basketY + basketHeight &&
                    flowerCenterX > basketX - basketWidth / 2 &&
                    flowerCenterX < basketX + basketWidth / 2 &&
                    !flower.counted) {
                    
                    flower.counted = true;
                    flowers.splice(i, 1);
                    
                    // Add points based on flower type
                    score += flower.points || 1;
                    updateScore();
                    
                    // Visual feedback could be added here (like a particle effect)
                    
                    i--;
                }
            }
        }
        
        function drawBasket() {
            // Draw the bucket image with proper proportions
            ctx.drawImage(
                bucketImage, 
                basketX - basketWidth / 2,
                basketY, 
                basketWidth, 
                basketHeight
            );
        }
        
        function drawFlowers() {
            flowers.forEach(flower => {
                ctx.save();
                ctx.translate(flower.x + flower.size/2, flower.y + flower.size/2);
                ctx.rotate(flower.rotation);
                
                // Draw flower - circular shape with more natural looking petals
                const innerRadius = flower.size/5;
                const outerRadius = flower.size/2;
                
                // Draw larger central circle as the main flower body
                ctx.fillStyle = flower.color;
                ctx.beginPath();
                ctx.arc(0, 0, outerRadius * 0.6, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw extra petals around the edge to make it look more like a flower
                const petalCount = 5;  // Fixed petal count for consistency
                
                for (let i = 0; i < petalCount; i++) {
                    const angle = (i * 2 * Math.PI / petalCount);
                    const petalX = Math.cos(angle) * (outerRadius * 0.7);
                    const petalY = Math.sin(angle) * (outerRadius * 0.7);
                    
                    ctx.beginPath();
                    ctx.arc(petalX, petalY, outerRadius * 0.5, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // Draw flower center
                // Special flowers have a sparkly white center
                ctx.fillStyle = flower.isSpecial ? '#ffffff' : '#ffff00';
                ctx.beginPath();
                ctx.arc(0, 0, innerRadius, 0, Math.PI * 2);
                ctx.fill();
                
                // Add a sparkle effect to special flowers
                if (flower.isSpecial) {
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 1;
                    for (let i = 0; i < 4; i++) {
                        const angle = i * Math.PI / 2;
                        ctx.beginPath();
                        ctx.moveTo(0, 0);
                        ctx.lineTo(Math.cos(angle) * outerRadius * 1.2, Math.sin(angle) * outerRadius * 1.2);
                        ctx.stroke();
                    }
                }
                
                ctx.restore();
            });
        }
        
        function updateScore() {
            scoreText.textContent = score.toString();
        }
        
        function updateTimer() {
            timerDisplay.textContent = `${gameTimer}s`;
            
            // Make timer red when it's getting low
            if (gameTimer <= 5) {
                timerDisplay.style.color = '#ff0000';
                timerDisplay.style.fontWeight = 'bold';
            } else {
                timerDisplay.style.color = '#ff69b4';
            }
        }
        
        function endGame(timeExpired = false) {
            gameActive = false;
            clearInterval(timerInterval);
            
            // Update the heading text based on how the game ended
            const gameOverHeading = document.querySelector('#gameOver h2');
            if (timeExpired) {
                gameOverHeading.textContent = 'Game Finished!';
            } else {
                gameOverHeading.textContent = 'Game Over!';
            }
            
            finalScore.textContent = `Your score: ${score}`;
            gameOverScreen.style.display = 'block';
            
            // Determine which coupon to award based on score
            let coupon;
            if (score <= COUPON_CONFIG.low.maxScore) {
                coupon = COUPON_CONFIG.low;
            } else if (score <= COUPON_CONFIG.medium.maxScore) {
                coupon = COUPON_CONFIG.medium;
            } else {
                coupon = COUPON_CONFIG.high;
            }
            
            // Send score and coupon data to CleverTap
            if (window.clevertap) {
                clevertap.event.push("Game_Completed", {
                    "score": score,
                    "gameMode": timeExpired ? "completed" : "lost",
                    "timeRemaining": gameTimer,
                    "couponTitle": coupon.title,
                    "couponCode": coupon.code,
                    "discountAmount": coupon.discount
                });
            }
            
            // Mobile app integration (similar to sample1.html)
            const gameData = {
                score: score,
                couponTitle: coupon.title,
                couponCode: coupon.code,
                discountAmount: coupon.discount
            };
            
            // For iOS WebView
            if(window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.clevertap) {
                const iosEvent = { 
                    action: 'recordEventWithProps', 
                    event: 'Game_Completed', 
                    props: gameData
                };
                window.webkit.messageHandlers.clevertap.postMessage(iosEvent);
            }
            
            // For Android WebView
            if (window.CleverTap) {
                window.CleverTap.pushEvent("Game_Completed", JSON.stringify(gameData));
            }
            
            // Show coupon after a short delay
            setTimeout(showCoupon, 1500, coupon);
        }

        function showCoupon(coupon) {
            // Update coupon modal with current coupon details
            document.getElementById('couponTitle').textContent = coupon.title;
            document.getElementById('discountText').textContent = coupon.discount;
            document.getElementById('couponCode').textContent = coupon.code;
            document.getElementById('couponDescription').textContent = coupon.description;
            
            // Hide game over screen and show coupon
            gameOverScreen.style.display = 'none';
            const couponModal = document.getElementById('couponModal');
            couponModal.style.display = 'flex';
        }
        
        // Initialize coupon modal events
        document.getElementById('closeCouponButton').addEventListener('click', function() {
            document.getElementById('couponModal').style.display = 'none';
            gameOverScreen.style.display = 'block';
        });

        // Touch and mouse event handlers
        gameCanvas.addEventListener('touchstart', function(e) {
            e.preventDefault();
            touchStartX = e.touches[0].clientX;
        });
        
        gameCanvas.addEventListener('touchmove', function(e) {
            e.preventDefault();
            if (gameActive) {
                const touchX = e.touches[0].clientX;
                const diffX = touchX - touchStartX;
                basketX += diffX;
                
                // Keep basket within canvas boundaries
                if (basketX < basketWidth / 2) {
                    basketX = basketWidth / 2;
                } else if (basketX > gameCanvas.width - basketWidth / 2) {
                    basketX = gameCanvas.width - basketWidth / 2;
                }
                
                touchStartX = touchX;
            }
        });
        
        gameCanvas.addEventListener('mousemove', function(e) {
            if (gameActive) {
                const rect = gameCanvas.getBoundingClientRect();
                basketX = e.clientX - rect.left;
                
                // Keep basket within canvas boundaries
                if (basketX < basketWidth / 2) {
                    basketX = basketWidth / 2;
                } else if (basketX > gameCanvas.width - basketWidth / 2) {
                    basketX = gameCanvas.width - basketWidth / 2;
                }
            }
        });
        
        // Add event listener for play again button
        playAgainButton.addEventListener('click', startGame);
        
        // Handle window resize
        window.addEventListener('resize', function() {
            if (gameActive) {
                // Save current ratio of basket position to canvas width
                const basketRatio = basketX / gameCanvas.width;
                
                setupCanvas();
                
                // Apply the same ratio to the new canvas width
                basketX = basketRatio * gameCanvas.width;
            } else {
                setupCanvas();
            }
        });
        
        // Initialize canvas size when images are loaded
        window.addEventListener('load', setupCanvas);
    </script>
</body>
</html>
